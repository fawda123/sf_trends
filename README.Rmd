---
title: "README"
output: 
  html_document:
    keep_md: yes
author: "Marcus W. Beck, beck.marcus@epa.gov"
---

### Files

**_data/_** Supporting RData files, usually from data in ignore folder, unless otherwise noted all files were created in `R/dat_proc.R`

* `bests.RData` subset of `flocor.RData` for min or max cor of each nut parm with flow or sal time series, respectively.  Each site is matched with the flow or salinity record ided in figure 10 of Novick et al

* `delt_dat.RData` Processed wq time series data `dwr_wq.RData`, includes all nitrogen analytes and current/active stations in the delta, also includes matched and smoothed flow records from `flocor.RData` results

* `dwr_wq.RData` time series data of stations in the SF delta from California DWR-EMP (Department of Water Resources, Environmental Monitoring Program) , processed by E. Novick, all stations, analytes from 1975 to present.  Most analytes are measured as concentration, see original spreadsheet for values.  Unavailable in GitHub repo.

* `flocor.RData` results of ccf analysis of selected delta and suisun stations comparing nitrogen and flow

* `flow_dat.RData` time series of daily flow estimates for the delta, input stations from Novick et al (Fig 2) were used

* `nutcor.RData` results of ccf analysis of selected delta and suisun stations comparing nitrogen species

* `mods.RData` dataset for wrtds, including model results. This is a nested data frame with identifiers.  All response, flow values are ln + 1 transformed, flow (or salinity) records for each nutrient variable and station are combined based on the monthly lag ided from `bests.RData`

**_R/_** Supporting R scripts

**_text/_** Summary text of analyses

### Comparing time series of nutrients and flow for selected stations

```{r echo = F, message = F}
library(ggplot2)
library(dplyr)
library(tidyr)
library(WRTDStidal)
library(gridExtra)
library(lubridate)
library(purrr)
library(GGally)
source('R/funcs.R')
```

Monthly nutrient samples at selected stations were compared with flow estimates to characterize variation in time series correlations. Time series were compared using cross-correlation analysis with lags +/- 12 months.  Selected stations from the delta were C10, C, and P8 and selected stations from Suisun were D4, D6, and D7.  Flow estimates from Novick et al. were the Sacramento River plus Yolo bypass (`sacyolo = sac + yolo`),  San Joaquin River (`sjr`).  Nutrient data were also compared with salinity observations at each station.  Nitrogen species evaluated included dissolved inorganic nitrogen (`din`), ammonium (`nh`), and nitrite/nitrate (`no23`). 

```{r fig.height = 7, fig.width = 11, echo = F}
data(flocor)

ggplot(flocor, aes(x = lag, y = acf, colour = flovar, group = flovar)) +
  facet_grid(Location + Site_Code ~ resvar) +
  geom_line() + 
  geom_point() + 
  scale_x_continuous('lag (months)') +
  theme_minimal() +
  theme(legend.position = 'top', legend.title = element_blank())
```
  
The above analysis was repeated to compare temporal variation of nitrogen species.  

```{r fig.height = 7, fig.width = 11, echo = F}
data(nutcor)

ggplot(nutcor, aes(x = lag, y = acf, colour = var2, group = var2)) +
  facet_grid(Location + Site_Code ~ var1) +
  geom_line() + 
  geom_point() + 
  scale_x_continuous('lag (months)') +
  theme_minimal() +
  theme(legend.position = 'top', legend.title = element_blank())

```

```{r, eval = T, out.width = '400px', fig.height = 9, fig.width = 9, echo = F, warning = F}

data(delt_dat)
data(flow_dat)

toplo <- tidyr::spread(flow_dat, station, q) %>% 
  select(-east) %>% 
  left_join(delt_dat, ., by = 'Date') %>% 
  select(-Latitude, -Longitude, -tn) %>% 
  gather('var', 'val', -Site_Code, -Date, -Location) %>% 
  na.omit %>% 
  mutate(
    val = log(1 + val)
    ) %>% 
  spread(var, val)

for(site in unique(toplo$Site_Code)){
  
  siteplo <- filter(toplo, Site_Code %in% site) %>% 
    select(-Site_Code, -Location, -Date)
  
  p <- ggpairs(siteplo, title = site)
  
  print(p)  
  
}

```

### Matching stations to flow or salinity records

```{r echo = F}
data(bests)
  
knitr::kable(bests, format = 'markdown', caption = 'Minimum correlations and lags of each nutrient station that corresponded to the flow estimates')
```
Sites were matched with flow or salinity records based on flow contributions in Novick et al.  Weighted regression models were run for each station and each nutrient species of nitrogen.   

```{r, fig.height = 7, fig.width = 12, echo = F, message = F, warning = F}

data(mods)
lims <- data.frame(
  var = c('din', 'nh', 'no23'),
  upy = c(1.3, 0.65, 1.25)
)

for(i in 1:nrow(mods)){

  toplo <- mods$mod[[i]]
  lab <- paste(mods[i, 'Location'], mods[i, 'Site_Code'], sep = ', ')
  
  limy <- as.character(mods[i, 'resvar'])
  limy <- lims[lims$var == limy, 'upy']
    
  p <- prdnrmplot(toplo) +
    ggtitle(lab) + 
    theme_minimal() +
    theme(axis.title = element_blank(), legend.position = 'top') +
    scale_y_continuous(limits = c(0, limy))

  # get legend
  if(i == 1) pleg <- g_legend(p)
  p <- p + theme(legend.position = 'none')

  assign(paste0('p', i), p)

}

# # for ref
# din <- which(mods$resvar == 'din')
# nh <- which(mods$resvar == 'nh')
# no23 <- which(mods$resvar == 'no23')

ylab1 <- attr(mods$mod[[1]], 'reslab')
ylab2 <- attr(mods$mod[[2]], 'reslab')
ylab3 <- attr(mods$mod[[3]], 'reslab')

grid.arrange(
  pleg, nrow = 2, heights = c(0.1, 1), 
  arrangeGrob(
  ncol = 2, widths = c(0.1, 1), 
    grid::textGrob(ylab1, rot = 90), 
    arrangeGrob(p1, p4, p7, p10, p13, p16, ncol = 3)
  )
)

grid.arrange(
  pleg, nrow = 2, heights = c(0.1, 1), 
  arrangeGrob(
  ncol = 2, widths = c(0.1, 1), 
    grid::textGrob(ylab2, rot = 90), 
    arrangeGrob(p2, p5, p8, p11, p14, p17, ncol = 3)
  )
)

grid.arrange(
  pleg, nrow = 2, heights = c(0.1, 1), 
  arrangeGrob(
  ncol = 2, widths = c(0.1, 1), 
    grid::textGrob(ylab3, rot = 90), 
    arrangeGrob(p3, p6, p9, p12, p15, p18, ncol = 3)
  )
)

```

```{r, fig.height = 10, fig.width = 12, echo = F, message = F, warning = F, eval = T}

data(mods)

# y axis limits for each plot
lims <- data.frame(
  var = c('din', 'nh', 'no23'),
  upy = c(1.7, 0.45, 1.3)
)

for(i in 1:nrow(mods)){

  toplo <- mods$mod[[i]]
  lab <- paste(mods[i, 'Location'], mods[i, 'Site_Code'], sep = ', ')
  
  limy <- as.character(mods[i, 'resvar'])
  limy <- lims[lims$var == limy, 'upy']
    
  p <- dynaplot(toplo, month = c(1, 4, 7, 10), ncol = 1) +
    ggtitle(lab) + 
    theme_minimal() +
    theme(axis.title = element_blank(), legend.position = 'top') +
    # scale_x_continuous(limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, limy))

  # flip if Suisun (salinity was used)
  if(as.character(mods[i, 'Location']) == 'Suisun')
    p <- p + scale_x_reverse()
  
  # get legend
  if(i == 1) pleg <- g_legend(p)
  p <- p + theme(legend.position = 'none')

  assign(paste0('p', i), p)

}

# # for ref
# din <- which(mods$resvar == 'din')
# nh <- which(mods$resvar == 'nh')
# no23 <- which(mods$resvar == 'no23')

ylab1 <- attr(mods$mod[[1]], 'reslab')
ylab2 <- attr(mods$mod[[2]], 'reslab')
ylab3 <- attr(mods$mod[[3]], 'reslab')

grid.arrange(
  pleg, nrow = 3, heights = c(0.1, 1, 0.1), 
  arrangeGrob(
  ncol = 2, widths = c(0.05, 1), 
    grid::textGrob(ylab1, rot = 90), 
    arrangeGrob(p1, p4, p7, p10, p13, p16, ncol = 6)
  ), 
  grid::textGrob('Flow or Salinity (standardized)')
)

grid.arrange(
  pleg, nrow = 3, heights = c(0.1, 1, 0.1), 
  arrangeGrob(
  ncol = 2, widths = c(0.05, 1), 
    grid::textGrob(ylab2, rot = 90), 
    arrangeGrob(p2, p5, p8, p11, p14, p17, ncol = 6)
  ), 
  grid::textGrob('Flow or Salinity (standardized)')
)

grid.arrange(
  pleg, nrow = 3, heights = c(0.1, 1, 0.1), 
  arrangeGrob(
  ncol = 2, widths = c(0.05, 1), 
    grid::textGrob(ylab3, rot = 90), 
    arrangeGrob(p3, p6, p9, p12, p15, p18, ncol = 6)
  ), 
  grid::textGrob('Flow or Salinity (standardized)')
)

```

Seasonal trends between years, flow-normalized results.
```{r, fig.height = 6.5, fig.width = 10, echo = F, message = F, warning = F, eval = T}

data(mods)

# y axis limits for each plot
lims <- data.frame(
  var = c('din', 'nh', 'no23'),
  upy = c(1.4, 0.6, 1.2)
)

for(i in 1:nrow(mods)){

  toplo <- mods$mod[[i]]
  lab <- paste(mods[i, 'Location'], mods[i, 'Site_Code'], sep = ', ')
  
  limy <- as.character(mods[i, 'resvar'])
  limy <- lims[lims$var == limy, 'upy']
    
  p <- seasyrplot(toplo, predicted = F) +
    ggtitle(lab) + 
    theme_minimal() +
    theme(axis.title = element_blank(), legend.position = 'top') +
    scale_y_continuous(limits = c(0, limy))

  # get legend
  if(i == 1) pleg <- g_legend(p)
  p <- p + theme(legend.position = 'none')

  assign(paste0('p', i), p)

}

ylab1 <- attr(mods$mod[[1]], 'reslab')
ylab2 <- attr(mods$mod[[2]], 'reslab')
ylab3 <- attr(mods$mod[[3]], 'reslab')

grid.arrange(
  pleg, nrow = 2, heights = c(0.1, 1), 
  arrangeGrob(
  ncol = 2, widths = c(0.1, 1), 
    grid::textGrob(ylab1, rot = 90), 
    arrangeGrob(p1, p4, p7, p10, p13, p16, ncol = 3)
  )
)

grid.arrange(
  pleg, nrow = 2, heights = c(0.1, 1), 
  arrangeGrob(
  ncol = 2, widths = c(0.1, 1), 
    grid::textGrob(ylab2, rot = 90), 
    arrangeGrob(p2, p5, p8, p11, p14, p17, ncol = 3)
  )
)

grid.arrange(
  pleg, nrow = 2, heights = c(0.1, 1), 
  arrangeGrob(
  ncol = 2, widths = c(0.1, 1), 
    grid::textGrob(ylab3, rot = 90), 
    arrangeGrob(p3, p6, p9, p12, p15, p18, ncol = 3)
  )
)

```


### To do 

* get detection limits

