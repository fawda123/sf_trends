---
title: "README"
output: 
  html_document:
    keep_md: yes
author: "Marcus W. Beck, beck.marcus@epa.gov"
---

### Files

**_data/_** Supporting RData files, usually from data in ignore folder, unless otherwise noted all files were created in `R/dat_proc.R`

* `delt_dat.RData` Processed wq time series data `dwr_wq.RData`, includes all nitrogen analytes and current/active stations in the delta, also includes matched and smoothed flow records from `flocor.RData` results

* `dwr_wq.RData` time series data of stations in the SF delta from California DWR-EMP (Department of Water Resources, Environmental Monitoring Program) , processed by E. Novick, all stations, analytes from 1975 to present.  Most analytes are measured as concentration, see original spreadsheet for values.  Unavailable in GitHub repo.

* `flocor.RData` results of ccf analysis of selected delta and suisun stations comparing nitrogen and flow

* `flow_dat.RData` time series of daily flow estimates for the delta, input stations from Novick et al (Fig 2) were used

* `nutcor.RData` results of ccf analysis of selected delta and suisun stations comparing nitrogen species

**_R/_** Supporting R scripts

**_text/_** Summary text of analyses

### Comparing time series of nutrients and flow for selected stations

```{r echo = F, message = F}
library(ggplot2)
library(dplyr)
library(tidyr)
library(WRTDStidal)
library(gridExtra)
library(lubridate)
library(purrr)
source('R/funcs.R')
```

Monthly nutrient samples at selected stations were compared with flow estimates to characterize variation in time series correlations. Time series were compared using cross-correlation analysis with lags +/- 12 months.  Selected stations from the delta were C10, C, and P8 and selected stations from Suisun were D4, D6, and D7.  Flow estimates from Novick et al. were the Sacramento River plus Yolo bypass (`sacyolo = sac + yolo`),  San Joaquin River (`sjr`).  Nutrient data were also compared with salinity observations at each station.  Nitrogen species evaluated included dissolved inorganic nitrogen (`din`), ammonium (`nh`), and nitrite/nitrate (`no23`). 

```{r fig.height = 7, fig.width = 11, echo = F}
data(flocor)

ggplot(flocor, aes(x = lag, y = acf, colour = flovar, group = flovar)) +
  facet_grid(Location + Site_Code ~ resvar) +
  geom_line() + 
  geom_point() + 
  scale_x_continuous('lag (months)') +
  theme_minimal() +
  theme(legend.position = 'top', legend.title = element_blank())
```
  
The above analysis was repeated to compare temporal variation of nitrogen species.  

```{r fig.height = 7, fig.width = 11, echo = F}
data(nutcor)

ggplot(nutcor, aes(x = lag, y = acf, colour = var2, group = var2)) +
  facet_grid(Location + Site_Code ~ var1) +
  geom_line() + 
  geom_point() + 
  scale_x_continuous('lag (months)') +
  theme_minimal() +
  theme(legend.position = 'top', legend.title = element_blank())

```

```{r, eval = F}

data(delt_dat)
data(flow_dat)

toplo <- tidyr::spread(flow_dat, station, q) %>% 
  select(-east) %>% 
  left_join(delt_dat, ., by = 'Date') %>% 
  select(-Latitude, -Longitude, -tn) %>% 
  gather('var', 'val', -Site_Code, -Date) %>% 
  na.omit %>% 
  mutate(
    val = log(1 + val), 
    ind = 1:nrow(.)
    ) %>% 
  spread(var, val) %>% 
  select(-ind)

for(site in unique(toplo$Site_Code)){
  
  siteplo <- filter(toplo, Site_Code %in% site) %>% 
    select(-Site_Code)
  
  p <- ggpairs(siteplo) + 
    theme_bw()
  
}


```

### Matching stations to flow or salinity records

Stations were 

### To do 

* get detection limits

